name: Laravel API

on:
  push:
    branches: [ 'main' ]
    paths: [ 'apiFrontAir/**' ]
  pull_request:
    branches: [ 'main' ]
    paths: [ 'apiFrontAir/**' ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout the repository
        uses: actions/checkout@v3

      - name: Check for changes in apiFrontAir directory
        id: check_changes
        run: |
          # Fetch the previous commit
          git fetch origin main
          # Check for changes in the specific directory
          if [ $(git diff --name-only HEAD HEAD~1 | grep '^apiFrontAir/') ]; then
            echo "Changes detected in apiFrontAir directory"
            echo "CHANGES=true" >> $GITHUB_ENV
          else
            echo "No changes detected in apiFrontAir directory"
            echo "CHANGES=false" >> $GITHUB_ENV
          fi

      - name: Check composer version
        if: ${{ env.CHANGES == 'true' }}
        run: composer -v
        
      - name: Verify node version
        if: ${{ env.CHANGES == 'true' }}
        run: node -v
        
      - name: Verify npm version
        if: ${{ env.CHANGES == 'true' }}
        run: npm -v

      - name: Install composer packages
        if: ${{ env.CHANGES == 'true' }}
        run: composer install
        working-directory: apiFrontAir

      - name: Linter (pint)
        if: ${{ env.CHANGES == 'true' }}
        run: pint
        working-directory: apiFrontAir

      - name: Run tests
        if: ${{ env.CHANGES == 'true' }}
        run: php artisan test
        working-directory: apiFrontAir

      - name: Build the API
        if: ${{ env.CHANGES == 'true' }}
        run: php artisan build
        working-directory: apiFrontAir

      - name: Migrate & seed database
        if: ${{ env.CHANGES == 'true' }}
        run: php artisan migrate:fresh --seed
        working-directory: apiFrontAir

      - name: Run API
        if: ${{ env.CHANGES == 'true' }}
        run: php artisan serve
        working-directory: apiFrontAir

      - name: Test API route
        if: ${{ env.CHANGES == 'true' }}
        run: |
          curl http://localhost/api/flights
